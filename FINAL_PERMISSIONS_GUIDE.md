# SQLAdmin å®Œæ•´æƒé™ç®¡ç†ç³»ç»Ÿ

## åŠŸèƒ½æ¦‚è¿°

æœ¬ç³»ç»ŸåŸºäº SQLAdmin å®˜æ–¹æœ€ä½³å®è·µï¼Œå®ç°äº†å®Œæ•´çš„åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ç³»ç»Ÿï¼Œå®Œå…¨æ»¡è¶³æ‚¨æå‡ºçš„æ‰€æœ‰éœ€æ±‚ã€‚

## æƒé™è§„åˆ™è¯¦è§£

### 1. è¶…çº§ç”¨æˆ·æƒé™ï¼ˆis_superuser=Trueï¼‰

#### ç”¨æˆ·ç®¡ç†ï¼š
- âœ… **æŸ¥çœ‹**ï¼šå¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
- âœ… **åˆ›å»º**ï¼šå¯ä»¥åˆ›å»ºæ–°ç”¨æˆ·
- âœ… **ç¼–è¾‘**ï¼šå¯ä»¥ç¼–è¾‘æ‰€æœ‰ç”¨æˆ·çš„æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬ is_superuser, is_active, pp_token ç­‰ï¼‰
- âœ… **åˆ é™¤**ï¼šå¯ä»¥åˆ é™¤ä»»ä½•ç”¨æˆ·

#### è®¤è¯å‡­æ®ç®¡ç†ï¼š
- âœ… **æŸ¥çœ‹**ï¼šå¯ä»¥æŸ¥çœ‹æ‰€æœ‰è®¤è¯å‡­æ®ï¼ˆå…¬å¼€å’Œç§æœ‰ï¼‰
- âœ… **åˆ›å»º**ï¼šå¯ä»¥åˆ›å»ºå…¬å¼€å‡­æ®å’Œç§æœ‰å‡­æ®
- âœ… **ç¼–è¾‘**ï¼šå¯ä»¥ç¼–è¾‘ä»»ä½•å‡­æ®çš„æ‰€æœ‰å­—æ®µ
- âœ… **åˆ é™¤**ï¼šå¯ä»¥åˆ é™¤ä»»ä½•å‡­æ®

### 2. æ™®é€šç”¨æˆ·æƒé™ï¼ˆis_superuser=Falseï¼‰

#### ç”¨æˆ·ç®¡ç†ï¼š
- âœ… **æŸ¥çœ‹**ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç”¨æˆ·ä¿¡æ¯
- âŒ **åˆ›å»º**ï¼šä¸èƒ½åˆ›å»ºæ–°ç”¨æˆ·
- ğŸ”’ **ç¼–è¾‘**ï¼šåªèƒ½ç¼–è¾‘è‡ªå·±çš„éƒ¨åˆ†å­—æ®µ
  - âœ… å¯ç¼–è¾‘ï¼š`username`, `email`, `remark`, `description`
  - âŒ ä¸å¯ç¼–è¾‘ï¼š`pp_token`, `is_superuser`, `is_active`
- âŒ **åˆ é™¤**ï¼šä¸èƒ½åˆ é™¤ç”¨æˆ·

#### è®¤è¯å‡­æ®ç®¡ç†ï¼š
##### è‡ªå·±çš„ç§æœ‰å‡­æ®ï¼ˆinfo_status=1 ä¸” user_id=è‡ªå·±ï¼‰ï¼š
- âœ… **æŸ¥çœ‹**ï¼šå¯ä»¥æŸ¥çœ‹
- âœ… **åˆ›å»º**ï¼šå¯ä»¥åˆ›å»ºï¼ˆè‡ªåŠ¨å…³è”åˆ°è‡ªå·±ï¼‰
- âœ… **ç¼–è¾‘**ï¼šå¯ä»¥ç¼–è¾‘å­—æ®µï¼š`info`, `expires_at`, `config_info`, `description`
- âœ… **åˆ é™¤**ï¼šå¯ä»¥åˆ é™¤

##### å…¬å¼€å‡­æ®ï¼ˆinfo_status=0ï¼‰ï¼š
- âœ… **æŸ¥çœ‹**ï¼šå¯ä»¥æŸ¥çœ‹
- âŒ **åˆ›å»º**ï¼šä¸èƒ½åˆ›å»ºå…¬å¼€å‡­æ®
- âŒ **ç¼–è¾‘**ï¼šä¸èƒ½ç¼–è¾‘
- âŒ **åˆ é™¤**ï¼šä¸èƒ½åˆ é™¤

##### ä»–äººçš„ç§æœ‰å‡­æ®ï¼š
- âŒ **æŸ¥çœ‹**ï¼šå®Œå…¨çœ‹ä¸åˆ°
- âŒ **åˆ›å»º**ï¼šä¸èƒ½ä¸ºä»–äººåˆ›å»º
- âŒ **ç¼–è¾‘**ï¼šä¸èƒ½ç¼–è¾‘
- âŒ **åˆ é™¤**ï¼šä¸èƒ½åˆ é™¤

## æŠ€æœ¯å®ç°

### 1. æŸ¥è¯¢å±‚é¢è¿‡æ»¤

æƒé™æ§åˆ¶åœ¨æ•°æ®åº“æŸ¥è¯¢å±‚é¢å®ç°ï¼Œç¡®ä¿ç”¨æˆ·æ— æ³•é€šè¿‡ä»»ä½•æ–¹å¼è®¿é—®æ— æƒæŸ¥çœ‹çš„æ•°æ®ï¼š

```python
# ç”¨æˆ·æŸ¥è¯¢è¿‡æ»¤
def get_list_query(self, request: Request):
    current_user = self.get_current_user(request)
    query = self.sessionmaker().query(self.model)
    
    if current_user.is_superuser:
        return query  # è¶…çº§ç”¨æˆ·çœ‹æ‰€æœ‰
    else:
        return query.filter(User.id == current_user.id)  # æ™®é€šç”¨æˆ·åªçœ‹è‡ªå·±

# è®¤è¯å‡­æ®æŸ¥è¯¢è¿‡æ»¤  
def get_list_query(self, request: Request):
    current_user = self.get_current_user(request)
    query = self.sessionmaker().query(self.model)
    
    if current_user.is_superuser:
        return query  # è¶…çº§ç”¨æˆ·çœ‹æ‰€æœ‰
    else:
        return query.filter(
            or_(
                # å…¬å¼€å‡­æ®
                AuthCredentials.info_status == InfoStatusTypeEnum.PUBLIC.value,
                # è‡ªå·±çš„ç§æœ‰å‡­æ®
                and_(
                    AuthCredentials.info_status == InfoStatusTypeEnum.PRIVATE.value,
                    AuthCredentials.user_id == current_user.id,
                ),
            )
        )
```

### 2. æ“ä½œæƒé™æ§åˆ¶

æ¯ä¸ªæ“ä½œï¼ˆåˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ï¼‰éƒ½æœ‰ç‹¬ç«‹çš„æƒé™æ£€æŸ¥ï¼š

```python
async def edit(self, request: Request) -> Response:
    current_user = self.get_current_user(request)
    
    if current_user.is_superuser:
        return await super().edit(request)  # è¶…çº§ç”¨æˆ·æ— é™åˆ¶
    else:
        # æ™®é€šç”¨æˆ·æƒé™æ£€æŸ¥
        if self.can_edit_by_normal_user(request):
            return await super().edit(request)
        else:
            raise PermissionError("æƒé™ä¸è¶³")
```

### 3. å­—æ®µçº§æƒé™æ§åˆ¶

åŠ¨æ€è°ƒæ•´è¡¨å•å­—æ®µï¼Œæ™®é€šç”¨æˆ·çœ‹ä¸åˆ°å’Œä¸èƒ½ç¼–è¾‘å—é™å­—æ®µï¼š

```python
def get_form_columns(self, request: Request, obj=None) -> List[str]:
    current_user = self.get_current_user(request)
    
    if current_user.is_superuser:
        return ["username", "email", "is_active", "is_superuser", ...]
    else:
        return ["username", "email", "remark", "description"]  # å—é™å­—æ®µ
```

### 4. è‡ªåŠ¨æ•°æ®å…³è”

æ™®é€šç”¨æˆ·åˆ›å»ºçš„ç§æœ‰å‡­æ®è‡ªåŠ¨å…³è”åˆ°è‡ªå·±ï¼š

```python
async def on_model_change(self, data, model, is_created, request):
    current_user = self.get_current_user(request)
    
    if is_created and not current_user.is_superuser:
        # æ™®é€šç”¨æˆ·åˆ›å»ºçš„å‡­æ®è‡ªåŠ¨è®¾ä¸ºç§æœ‰å¹¶å…³è”åˆ°è‡ªå·±
        model.info_status = InfoStatusTypeEnum.PRIVATE.value
        model.user_id = current_user.id
```

## å¯åŠ¨å’Œæµ‹è¯•

### å¯åŠ¨åº”ç”¨

```bash
# å¯åŠ¨å®Œæ•´æƒé™ç®¡ç†ç‰ˆæœ¬
python main_final.py

# åº”ç”¨å°†åœ¨ http://127.0.0.1:8000 å¯åŠ¨
# ç®¡ç†ç•Œé¢åœ°å€ï¼šhttp://127.0.0.1:8000/admin
```

### API æµ‹è¯•ç«¯ç‚¹

- `GET /api/user/profile` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯å’Œæƒé™
- `GET /api/users/count` - è·å–å¯è§ç”¨æˆ·æ•°é‡
- `GET /api/credentials/count` - è·å–å¯è§å‡­æ®æ•°é‡
- `GET /api/my/credentials` - è·å–è‡ªå·±çš„ç§æœ‰å‡­æ®
- `GET /api/public/credentials` - è·å–å…¬å¼€å‡­æ®
- `GET /api/permissions/test` - å®Œæ•´æƒé™ç³»ç»Ÿæµ‹è¯•

### æµ‹è¯•æ­¥éª¤

1. **åˆ›å»ºæµ‹è¯•ç”¨æˆ·**ï¼š
   ```bash
   # é¦–å…ˆåˆ›å»ºè¶…çº§ç”¨æˆ·
   python create_admin.py
   
   # ç„¶åé€šè¿‡ç®¡ç†ç•Œé¢åˆ›å»ºæ™®é€šç”¨æˆ·ï¼ˆis_superuser=Falseï¼‰
   ```

2. **æµ‹è¯•è¶…çº§ç”¨æˆ·**ï¼š
   - ç™»å½•è¶…çº§ç”¨æˆ·è´¦æˆ·
   - éªŒè¯å¯ä»¥çœ‹åˆ°æ‰€æœ‰ç”¨æˆ·å’Œè®¤è¯å‡­æ®
   - éªŒè¯å¯ä»¥åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ä»»ä½•è®°å½•

3. **æµ‹è¯•æ™®é€šç”¨æˆ·**ï¼š
   - ç™»å½•æ™®é€šç”¨æˆ·è´¦æˆ·
   - éªŒè¯åªèƒ½çœ‹åˆ°è‡ªå·±çš„ç”¨æˆ·ä¿¡æ¯
   - éªŒè¯åªèƒ½çœ‹åˆ°å…¬å¼€å‡­æ®å’Œè‡ªå·±çš„ç§æœ‰å‡­æ®
   - éªŒè¯ä¸èƒ½ä¿®æ”¹ pp_token ç­‰å—é™å­—æ®µ
   - éªŒè¯åˆ›å»ºå‡­æ®æ—¶è‡ªåŠ¨å…³è”åˆ°è‡ªå·±

4. **API æµ‹è¯•**ï¼š
   ```bash
   # ä½¿ç”¨æµè§ˆå™¨æˆ– curl æµ‹è¯• API
   curl http://127.0.0.1:8000/api/permissions/test
   ```

## å®‰å…¨ç‰¹æ€§

### 1. æ•°æ®éš”ç¦»
- æŸ¥è¯¢å±‚é¢è¿‡æ»¤ç¡®ä¿ç”¨æˆ·çœ‹ä¸åˆ°æ— æƒè®¿é—®çš„æ•°æ®
- æ²¡æœ‰æ•°æ®æ³„éœ²é£é™©

### 2. æ“ä½œä¿æŠ¤
- æ¯ä¸ªæ“ä½œéƒ½æœ‰æƒé™æ£€æŸ¥
- é˜²æ­¢æƒé™æå‡æ”»å‡»

### 3. å­—æ®µä¿æŠ¤
- æ•æ„Ÿå­—æ®µï¼ˆå¦‚ pp_tokenï¼‰å—åˆ°ä¿æŠ¤
- æ™®é€šç”¨æˆ·æ— æ³•ä¿®æ”¹å…³é”®ç³»ç»Ÿå­—æ®µ

### 4. è‡ªåŠ¨å…³è”
- æ™®é€šç”¨æˆ·åˆ›å»ºçš„æ•°æ®è‡ªåŠ¨å…³è”åˆ°è‡ªå·±
- é˜²æ­¢æ•°æ®å½’å±æ··ä¹±

## é”™è¯¯å¤„ç†

ç³»ç»Ÿæä¾›å‹å¥½çš„é”™è¯¯å¤„ç†ï¼š
- æƒé™ä¸è¶³æ—¶æ˜¾ç¤ºæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- æä¾›è¿”å›é“¾æ¥ï¼Œä¸ä¼šè®©ç”¨æˆ·è¿·å¤±
- API è¿”å›æ ‡å‡†çš„ HTTP çŠ¶æ€ç å’Œé”™è¯¯ä¿¡æ¯

## æ‰©å±•æ€§

æœ¬ç³»ç»Ÿè®¾è®¡å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ï¼š
- æ˜“äºæ·»åŠ æ–°çš„æƒé™è§„åˆ™
- æ”¯æŒæ›´å¤æ‚çš„è§’è‰²ç³»ç»Ÿ
- å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„æ•°æ®æ¨¡å‹å’Œæƒé™æ§åˆ¶

è¿™ä¸ªå®ç°å®Œå…¨åŸºäº SQLAdmin çš„å®˜æ–¹æœ€ä½³å®è·µï¼Œæ»¡è¶³æ‚¨æå‡ºçš„æ‰€æœ‰éœ€æ±‚ï¼Œå¹¶æä¾›äº†é¢å¤–çš„å®‰å…¨ä¿éšœå’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–ã€‚
